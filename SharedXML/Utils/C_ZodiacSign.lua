local E_CHARACTER_RACES = E_CHARACTER_RACES

local ZODIAC_SIGNS = {
	{
		raceID = E_CHARACTER_RACES.RACE_HUMAN,
		name = ZODIAC_SING_OF_LION_NAME,
		description = ZODIAC_SING_OF_LION_DESCRIPTION,
		icon = [[Interface/Icons/Human_Lion]],
		atlas = "Custom-Zodiac-Sign-Human-Lion",
	},
	{
		raceID = E_CHARACTER_RACES.RACE_LIGHTFORGED,
		name = ZODIAC_SING_OF_NAARU_NAME,
		description = ZODIAC_SING_OF_NAARU_DESCRIPTION,
		icon = [[Interface/Icons/Lightforged_Naaru]],
		atlas = "Custom-Zodiac-Sign-Lightforged-Naaru",
	},
	{
		raceID = E_CHARACTER_RACES.RACE_NAGA,
		name = ZODIAC_SING_OF_SERPENT_NAME,
		description = ZODIAC_SING_OF_SERPENT_DESCRIPTION,
		icon = [[Interface/Icons/Naga_Snake]],
		atlas = "Custom-Zodiac-Sign-Naga-Serpent",
	},
	{
		raceID = E_CHARACTER_RACES.RACE_NIGHTELF,
		name = ZODIAC_SING_OF_SENTINEL_NAME,
		description = ZODIAC_SING_OF_SENTINEL_DESCRIPTION,
		icon = [[Interface/Icons/NightElf_Sentinel]],
		atlas = "Custom-Zodiac-Sign-NightElf-Sentinel",
	},
	{
		raceID = E_CHARACTER_RACES.RACE_NIGHTBORNE,
		name = ZODIAC_SING_OF_MAGISTER_NAME,
		description = ZODIAC_SING_OF_MAGISTER_DESCRIPTION,
		icon = [[Interface/Icons/Nightborne_Magister]],
		atlas = "Custom-Zodiac-Sign-Nightborne-Magister",
	},
	{
		raceID = E_CHARACTER_RACES.RACE_ORC,
		name = ZODIAC_SING_OF_BARBARIAN_NAME,
		description = ZODIAC_SING_OF_BARBARIAN_DESCRIPTION,
		icon = [[Interface/Icons/Orc_Barbarian]],
		atlas = "Custom-Zodiac-Sign-Orc-Barbarian",
	},
	{
		raceID = E_CHARACTER_RACES.RACE_PANDAREN_NEUTRAL,
		name = ZODIAC_SING_OF_HARMONY_NAME,
		description = ZODIAC_SING_OF_HARMONY_DESCRIPTION,
		icon = [[Interface/Icons/Pandaren_Harmony]],
		atlas = "Custom-Zodiac-Sign-Pandaren-Harmony",
	},
	{
		raceID = E_CHARACTER_RACES.RACE_QUELDO,
		name = ZODIAC_SING_OF_ARISTOCRAT_NAME,
		description = ZODIAC_SING_OF_ARISTOCRAT_DESCRIPTION,
		icon = [[Interface/Icons/Queldo_Aristocrat]],
		atlas = "Custom-Zodiac-Sign-Queldo-Aristocrat",
	},
	{
		raceID = E_CHARACTER_RACES.RACE_SCOURGE,
		name = ZODIAC_SING_OF_GHOUL_NAME,
		description = ZODIAC_SING_OF_GHOUL_DESCRIPTION,
		icon = [[Interface/Icons/Scourge_Ghoul]],
		atlas = "Custom-Zodiac-Sign-Scourge-Ghoul",
	},
	{
		raceID = E_CHARACTER_RACES.RACE_BLOODELF,
		name = ZODIAC_SING_OF_PHOENIX_NAME,
		description = ZODIAC_SING_OF_PHOENIX_DESCRIPTION,
		icon = [[Interface/Icons/BloodElf_Phoenix]],
		atlas = "Custom-Zodiac-Sign-BloodElf-Phoenix",
	},
	{
		raceID = E_CHARACTER_RACES.RACE_DARKIRONDWARF,
		name = ZODIAC_SING_OF_VULKAN_NAME,
		description = ZODIAC_SING_OF_VULKAN_DESCRIPTION,
		icon = [[Interface/Icons/DarkIronDwarf_Vulkan]],
		atlas = "Custom-Zodiac-Sign-DarkIronDwarf-Vulkan",
	},
	{
		raceID = E_CHARACTER_RACES.RACE_DRACTHYR,
		name = ZODIAC_SING_OF_DRAGON_NAME,
		description = ZODIAC_SING_OF_DRAGON_DESCRIPTION,
		icon = [[Interface/Icons/Dracthyr_Dragon]],
		atlas = "Custom-Zodiac-Sign-Dracthyr-Dragon",
	},
	{
		raceID = E_CHARACTER_RACES.RACE_DRAENEI,
		name = ZODIAC_SING_OF_WANDERER_NAME,
		description = ZODIAC_SING_OF_WANDERER_DESCRIPTION,
		icon = [[Interface/Icons/Draenei_Wanderer]],
		atlas = "Custom-Zodiac-Sign-Draenei-Wanderer",
	},
	{
		raceID = E_CHARACTER_RACES.RACE_DWARF,
		name = ZODIAC_SING_OF_ANVIL_NAME,
		description = ZODIAC_SING_OF_ANVIL_DESCRIPTION,
		icon = [[Interface/Icons/Dwarf_Anvil]],
		atlas = "Custom-Zodiac-Sign-Dwarf-Anvil",
	},
	{
		raceID = E_CHARACTER_RACES.RACE_EREDAR,
		name = ZODIAC_SING_OF_DEMON_NAME,
		description = ZODIAC_SING_OF_DEMON_DESCRIPTION,
		icon = [[Interface/Icons/Eredar_Demon]],
		atlas = "Custom-Zodiac-Sign-Eredar-Demon",
	},
	{
		raceID = E_CHARACTER_RACES.RACE_GNOME,
		name = ZODIAC_SING_OF_INVENTOR_NAME,
		description = ZODIAC_SING_OF_INVENTOR_DESCRIPTION,
		icon = [[Interface/Icons/Gnome_Inventor]],
		atlas = "Custom-Zodiac-Sign-Gnome-Inventor",
	},
	{
		raceID = E_CHARACTER_RACES.RACE_GOBLIN,
		name = ZODIAC_SING_OF_MERCHANT_NAME,
		description = ZODIAC_SING_OF_MERCHANT_DESCRIPTION,
		icon = [[Interface/Icons/Goblin_Merchant]],
		atlas = "Custom-Zodiac-Sign-Goblin-Merchant",
	},
	{
		raceID = E_CHARACTER_RACES.RACE_TAUREN,
		name = ZODIAC_SING_OF_BULL_NAME,
		description = ZODIAC_SING_OF_BULL_DESCRIPTION,
		icon = [[Interface/Icons/Tauren_Bull]],
		atlas = "Custom-Zodiac-Sign-Tauren-Bull",
	},
	{
		raceID = E_CHARACTER_RACES.RACE_TROLL,
		name = ZODIAC_SING_OF_VOODOO_NAME,
		description = ZODIAC_SING_OF_VOODOO_DESCRIPTION,
		icon = [[Interface/Icons/Troll_Voodoo]],
		atlas = "Custom-Zodiac-Sign-Troll-Voodoo",
	},
	{
		raceID = E_CHARACTER_RACES.RACE_VOIDELF,
		name = ZODIAC_SING_OF_FACELESS_NAME,
		description = ZODIAC_SING_OF_FACELESS_DESCRIPTION,
		icon = [[Interface/Icons/VoidElf_Faceless]],
		atlas = "Custom-Zodiac-Sign-VoidElf-Faceless",
	},
	{
		raceID = E_CHARACTER_RACES.RACE_VULPERA_NEUTRAL,
		name = ZODIAC_SING_OF_FOX_NAME,
		description = ZODIAC_SING_OF_FOX_DESCRIPTION,
		icon = [[Interface/Icons/Vulpera_Fox]],
		atlas = "Custom-Zodiac-Sign-Vulpera-Fox",
	},
	{
		raceID = E_CHARACTER_RACES.RACE_WORGEN,
		name = ZODIAC_SING_OF_WOLF_NAME,
		description = ZODIAC_SING_OF_WOLF_DESCRIPTION,
		icon = [[Interface/Icons/Worgen_Wolf]],
		atlas = "Custom-Zodiac-Sign-Worgen-Wolf",
	},
	{
		raceID = E_CHARACTER_RACES.RACE_ZANDALARITROLL,
		name = ZODIAC_SING_OF_LIZARD_NAME,
		description = ZODIAC_SING_OF_LIZARD_DESCRIPTION,
		icon = [[Interface/Icons/ZandalariTroll_Lizard]],
		atlas = "Custom-Zodiac-Sign-ZandalariTroll-Lizard",
	},
}

ZODIAC_DEBUFFS = {
	[371788] = E_CHARACTER_RACES.RACE_BLOODELF,
	[371789] = E_CHARACTER_RACES.RACE_DARKIRONDWARF,
	[371790] = E_CHARACTER_RACES.RACE_DRACTHYR,
	[371791] = E_CHARACTER_RACES.RACE_DRAENEI,
	[371792] = E_CHARACTER_RACES.RACE_DWARF,
	[371793] = E_CHARACTER_RACES.RACE_EREDAR,
	[371794] = E_CHARACTER_RACES.RACE_GNOME,
	[371795] = E_CHARACTER_RACES.RACE_GOBLIN,
	[371796] = E_CHARACTER_RACES.RACE_HUMAN,
	[371797] = E_CHARACTER_RACES.RACE_LIGHTFORGED,
	[371798] = E_CHARACTER_RACES.RACE_NAGA,
	[371799] = E_CHARACTER_RACES.RACE_NIGHTBORNE,
	[371800] = E_CHARACTER_RACES.RACE_NIGHTELF,
	[371801] = E_CHARACTER_RACES.RACE_ORC,
	[371802] = E_CHARACTER_RACES.RACE_PANDAREN_NEUTRAL,
	[371803] = E_CHARACTER_RACES.RACE_QUELDO,
	[371804] = E_CHARACTER_RACES.RACE_SCOURGE,
	[371805] = E_CHARACTER_RACES.RACE_TAUREN,
	[371806] = E_CHARACTER_RACES.RACE_TROLL,
	[371807] = E_CHARACTER_RACES.RACE_VOIDELF,
	[371808] = E_CHARACTER_RACES.RACE_VULPERA_NEUTRAL,
	[371809] = E_CHARACTER_RACES.RACE_WORGEN,
	[371810] = E_CHARACTER_RACES.RACE_ZANDALARITROLL,
}

local PRIVATE = {
	SIGN_INDEX_BY_RACE = {},
}

local OVERRIDE_RACEID = {
	[E_CHARACTER_RACES.RACE_PANDAREN_ALLIANCE] = E_CHARACTER_RACES.RACE_PANDAREN_NEUTRAL,
	[E_CHARACTER_RACES.RACE_PANDAREN_HORDE] = E_CHARACTER_RACES.RACE_PANDAREN_NEUTRAL,
	[E_CHARACTER_RACES.RACE_VULPERA_ALLIANCE] = E_CHARACTER_RACES.RACE_VULPERA_NEUTRAL,
	[E_CHARACTER_RACES.RACE_VULPERA_HORDE] = E_CHARACTER_RACES.RACE_VULPERA_NEUTRAL,
}

PRIVATE.GetSpellsFromDescription = function(raceFile, globalKeyFormat, isGlue)
	local spells = {}

	local spellIndex = 1
	local spellDataKey = string.format(globalKeyFormat, raceFile:upper(), spellIndex)
	local spell = _G[spellDataKey]
	while spell do
		local spellID, name, icon, description = string.split("|", spell)

		if isGlue then
			spells[spellIndex] = {
				id = tonumber(spellID),
				name = name,
				description = description,
				icon = strconcat("Interface/Icons/", icon),
				iconName = icon,
			}
		else
			spells[spellIndex] = tonumber(spellID)
			_G[spellDataKey] = nil
		end

		spellIndex = spellIndex + 1
		spell = _G[string.format(globalKeyFormat, raceFile:upper(), spellIndex)]
	end

	return spells
end

PRIVATE.Initialize = function()
	local isOnGlueScreen = IsOnGlueScreen()

	for index, sign in ipairs(ZODIAC_SIGNS) do
		local raceFile = S_CHARACTER_RACES_INFO[sign.raceID].clientFileString
		sign.activeSpells = PRIVATE.GetSpellsFromDescription(raceFile, "CHAR_INFO_RACE_%s_SPELL_ACTIVE%d", isOnGlueScreen)
		sign.passiveSpells = PRIVATE.GetSpellsFromDescription(raceFile, "CHAR_INFO_RACE_%s_SPELL_PASSIVE%d", isOnGlueScreen)
	end

	if isOnGlueScreen then
		local alliedRaces = {}
		local index = 1
		local sign = ZODIAC_SIGNS[index]
		while sign do
			if C_CharacterCreation.IsAlliedRace(sign.raceID) then
				table.insert(alliedRaces, table.remove(ZODIAC_SIGNS, index))
			end
			index = index + 1
			sign = ZODIAC_SIGNS[index]
		end

		local alliedSignPos = math.floor(#ZODIAC_SIGNS / 2) + 1
		for i = 1, #alliedRaces do
			table.insert(ZODIAC_SIGNS, alliedSignPos + i, table.remove(alliedRaces))
		end
	end

	for index, sign in ipairs(ZODIAC_SIGNS) do
		PRIVATE.SIGN_INDEX_BY_RACE[sign.raceID] = index
	end
end

PRIVATE.GetZodiacSignIndexByRaceID = function(raceID)
	if OVERRIDE_RACEID[raceID] then
		raceID = OVERRIDE_RACEID[raceID]
	end
	return PRIVATE.SIGN_INDEX_BY_RACE[raceID]
end

PRIVATE.Initialize()

C_ZodiacSign = {}

if IsOnGlueScreen() then
	function C_ZodiacSign.GetNumZodiacSigns()
		return #ZODIAC_SIGNS
	end

	function C_ZodiacSign.GetZodiacSignIndexByRaceID(raceID)
		return PRIVATE.GetZodiacSignIndexByRaceID(raceID)
	end

	function C_ZodiacSign.GetZodiacSignInfoByIndex(index)
		if type(index) ~= "number" then
			error(string.format("bad argument #1 to 'C_ZodiacSign.GetZodiacSignInfoByIndex' (number expected, got %s)", type(index)), 2)
		elseif index < 1 or index > #ZODIAC_SIGNS then
			error(string.format("C_ZodiacSign.GetZodiacSignInfoByIndex: index out of range `%s`", index), 2)
		end

		local sign = ZODIAC_SIGNS[index]
		if sign then
			return sign.raceID, sign.name, sign.description, sign.icon, sign.atlas
		end
	end
end

function C_ZodiacSign.GetZodiacSignInfo(raceID)
	if type(raceID) ~= "number" then
		error(string.format("bad argument #1 to 'C_ZodiacSign.GetZodiacSignInfo' (number expected, got %s)", type(raceID)), 2)
	elseif not E_CHARACTER_RACES[raceID] then
		error(string.format("C_ZodiacSign.GetZodiacSignInfo: Unknown raceID `%s`", raceID), 2)
	end

	local index = PRIVATE.GetZodiacSignIndexByRaceID(raceID)
	local sign = ZODIAC_SIGNS[index]
	if sign then
		return sign.raceID, sign.name, sign.description, sign.icon, sign.atlas
	end
end

function C_ZodiacSign.GetZodiacSignSpells(raceID)
	if type(raceID) ~= "number" then
		error(string.format("bad argument #1 to 'C_ZodiacSign.GetZodiacSignSpells' (number expected, got %s)", type(raceID)), 2)
	elseif not E_CHARACTER_RACES[raceID] then
		error(string.format("C_ZodiacSign.GetZodiacSignSpells: Unknown raceID `%s`", raceID), 2)
	end

	local index = PRIVATE.GetZodiacSignIndexByRaceID(raceID)
	local sign = ZODIAC_SIGNS[index]
	if sign then
		return sign.activeSpells, sign.passiveSpells
	end
end